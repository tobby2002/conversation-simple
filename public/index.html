<html>
<head>
  <base href="/">
  <title>Mrtalk Chat App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta property="og:image" content="conversation.svg" />
  <meta property="og:title" content="Conversation Chat Simple" />
  <meta property="og:description" content="Mr.TALK Sample application that shows how to use the Conversation API to identify user intents" />
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="css/app.css">
  <script type="text/javascript" src="//code.jquery.com/jquery-latest.min.js"></script>

</head>
<body>

  <style scoped="">
    #speechbbbbox {border-radius:0em;top:-0em;padding:0em;padding-right:0em;border:0px solid #e0e0e0;font-size:14px;font-family:'돋움',Dotum,AppleGothic,sans-serif;position:relative;background:#f9f9f9;min-height:0em}
    #speechbbbbox img {position:absolute;top:-2.7em;right:0.4em;border-radius:5.4em;border:0px solid #e9e9e9;background:#f0f0f0;padding:.0em;cursor:pointer}
    #speechbbbbox img :hover,#speechbbbbox.on img {background:rgba(234,67,53,0.7);font-weight:bold}
    #speechbbbbox {color:#333}
    #speechbbbbox span{display:block}
    #speechbbbbox .cning{color:#bbb}
  </style>
  <div id="view-change-button" class="button" onclick="PayloadPanel.togglePanel(event, this)">
    <img class="option full" src="../img/Chat Button.png">
    <img class="option not-full" src="../img/Code Button.png">
  </div>
  <div id="contentParent" class="responsive-columns-wrapper">
    <div id="chat-column-holder" class="responsive-column content-column">
      <div class="chat-column">
        <div id="scrollingChat"></div>

        <label for="textInput" class="inputOutline">
          <input id="textInput" class="input responsive-column"
            placeholder="여기에 입력후 엔터키 또는 마이크에 말하세요" type="text"
            onkeydown="ConversationPanel.inputKeyDown(event, this)">
        </label>
        <div id="speechbbbbox">
            <img id="mic_img" src="../img/mic_off.png" align="absmiddle" style="width:35px;height:35px;">
        </div>
      </div>
    </div>
    <div id="payload-column" class="fixed-column content-column" style="display:;">
      <div id="payload-initial-message">
        인공지능 'MR.TALK' 에게 말을 걸어 보세요.
      </div>
      <div id="payload-request" class="payload"></div>
      <div id="payload-response" class="payload"></div>
    </div>
  </div>

  <script src="js/common.js"></script>
  <script src="js/api.js"></script>
  <script src="js/conversation.js"></script>
  <script src="js/mrtalkrecognition.js"></script>
  <script src="js/payload.js"></script>
  <script src="js/global.js"></script>

  <script type="text/javascript" language = "javascript">

    var miccount = 0;
    if(!('webkitSpeechRecognition' in window)) {
//    if(true) {
//        $('#speechbbbbox').html('<strong>지원하지 않는 브라우저입니다.</strong>');
        $('#textInput').attr("placeholder", "여기에 입력후 엔터키, 마이크 크롬뷰어사용 권장");
    }
    else {
      var mic = new webkitSpeechRecognition();
      mic.continuous = false;
      mic.interimResults = true;
      mic.lang = 'ko-KR';
      $('#speechbbbbox').append('<span class="cning"></span>');
      mic.onresult = function(e) {
        var b = '', c = false;
        for(var i = e.resultIndex; i < e.results.length; ++i) {
          b += e.results[i][0].transcript;
          c = e.results[i].isFinal;
        }

//        if($('#speechbbbbox .cning').length < 1) {
//          $('#speechbbbbox').append('<span class="cning"></span>');
//        }
//        $('#speechbbbbox .cning').text(b);
          $('#textInput').attr("placeholder", b);

        if(c) {
//          $('#speechbbbbox .cning').removeClass('cning');

          if(true) {
            var inputObj = $('#textInput');
            // Retrieve the context from the previous server response
            var context;
            var latestResponse = Api.getResponsePayload();
            if (latestResponse) {
              context = latestResponse.context;
            }

            inputObj.value = b;
            // Send the user message
            Api.sendRequest(inputObj.value, context);
            // Clear input box for further messages
            inputObj.value = '';
            $('#textInput').attr("placeholder", "");
            Common.fireEvent(inputObj, 'input');
            miccount = 0;

          }
        }

      };
      mic.onend = function() {
        ++miccount;
        if (miccount < 4) {
//          $('#mic_img').attr("src", "../img/mic_off.png");
          mic.start();
          $('#mic_img').attr("src", "../img/mic_on.png");
        } else {
          miccount = 0
          $('#speechbbbbox').removeClass('on');;
          $('#mic_img').attr("src", "../img/mic_off.png");
          $('#textInput').attr("placeholder", "여기에 입력 또는 마이크를 사용하세요");
          mic.stop();
        }
      };

      $('#speechbbbbox img').click(function() {
        if ($('#speechbbbbox').hasClass('on')) {
          $('#mic_img').attr("src", "../img/mic_off.png");
          $('#textInput').attr("placeholder", "");
          mic.stop();
        }else {
          //alert('마이크로 말하시면 한국어가 입력됩니다.');
          $('#mic_img').attr("src", "../img/mic_on.png");
          mic.start();
        }
        $('#speechbbbbox').toggleClass('on');
      });
    }

  </script>
</body>
</html>